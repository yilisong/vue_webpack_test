<template>
<ComboTable :total="scanTaskTotal"
  :page-size="pageSize"
  :page-sizes="pageSizes"
  :currentPage="currentPage"
  @on-size-change="handleScanTaskListChange"
  @on-current-change="handleScanTaskListChange">
  <div slot="body">
    <el-table :data="scanTaskList"
      style="width: 100%">
      <el-table-column prop="property_object"
        label="扫描对象"
        min-width="150">
      </el-table-column>
      <el-table-column prop="scan_pattern"
        label="扫描模式"
        align="center">
        <template scope="scope">
          {{ codemap.pattern.get(scope.row.scan_pattern) }}
        </template>
      </el-table-column>
      <el-table-column prop="scan_agreement"
        label=" 配置类型"
        align="center">
        <template scope="scope">
          {{ scope.row.is_plan === '0' ? '立即任务' : '计划任务' }}
        </template>
      </el-table-column>
      <el-table-column prop="terrace"
        label="扫描情况"
        align="center">
        <template scope="scope">
          {{ scope.row.scan_status_name }}
          <template v-if="scope.row.is_plan === '1'">
            {{ scope.row.use_number }}/{{ scope.row.total_number }}次 <span v-show="scope.row.is_cancel">({{ scope.row.is_cancel }})</span>
          </template>
        </template>
      </el-table-column>
      <el-table-column prop="created_at"
        width="80"
        align="center"
        label="添加时间">
      </el-table-column>
      <el-table-column label="操作"
        min-width="100"
        align="right">
        <template scope="scope">
          <div v-show="scope.row.is_ban">
            <el-button type="text" size="small" @click="triggerAddScanVisible({visible: true, info: scope.row})">管理</el-button>
            <span class="vertical-separator">|</span>
            <el-popover ref="cancelCycleScan" v-model="popoverVisible[scope.$index]"
               placement="top-end" trigger="click">
              <div style="text-align: right; margin: 0">
                <el-button size="mini" type="text" @click="popoverVisible = []">取消</el-button>
                <el-button type="primary" size="mini" @click="handleCancelCycleScan(scope.row.id)">确定</el-button>
              </div>
            </el-popover>
            <el-button type="text" size="small" v-popover:cancelCycleScan>取消剩余计划</el-button>
          </div>
          <div v-show="!scope.row.is_ban">
            <el-button type="text" size="small" disabled>管理</el-button>
            <span class="vertical-separator">|</span>
            <el-button type="text" size="small" disabled>取消剩余计划</el-button>
          </div>
        </template>
      </el-table-column>
    </el-table>
    <AddScan modify/>
  </div>
</ComboTable>
</template>

<script>
import ComboTable from 'common/components/ComboTable/ComboTable'
import AddScan from '../PropertyList/AddScan'
import ListQuery from '../../constants/ListQuery'
import { mapActions } from 'vuex'

export default {
  components: {
    ComboTable,
    AddScan
  },
  methods: {
    ...mapActions(['getScanTaskList', 'cancelCycleScan', 'triggerAddScanVisible']),
    async handleScanTaskListChange(current, size) {
      try {
        await this.getScanTaskList({
          page: current,
          per_page: size
        })
        this.currentPage = current
        this.pageSize = size
      } catch (err) {}
    },
    async handleCancelCycleScan(id) {
      try {
        await this.cancelCycleScan(id)
        await this.getScanTaskList(ListQuery)
        this.popoverVisible = []
        this.currentPage = 1
      } catch (err) {}
    }
  },
  computed: {
    scanTaskList() {
      return this.$store.state.scan.scanTask.list
    },
    scanTaskTotal() {
      return this.$store.state.scan.scanTask.total
    }
  },
  created() {
    this.getScanTaskList(ListQuery)
  },
  data() {
    return {
      currentPage: 1,
      codemap: {
        pattern: new Map([['1', '快速'], ['2', '标准'], ['3', '全面']]),
        status: new Map([['0', '未开始'], ['1', '准备中'], ['2', '进行中'], ['3', '已完成']])
      },
      popoverVisible: [],
      pageSizes: [10, 20],
      pageSize: 10
    }
  }
}
</script>
